---
title: "Progetto di Fondamenti di Scienza dei Dati"
author: "Denis Gasparollo"
date: "2022-08-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Il datasets presi in considerazione sono 3: 

 * [link](https://espace.library.uq.edu.au/view/UQ:dfe5027) il quale contiene informazioni su data breach e ransomware tra il 2004 e l'inizio del 2020 raccolti dall'università del Queensland;
 * [link](https://en.wikipedia.org/wiki/List_of_data_breaches), che non è che il risultato di uno scrapping;
 * [link](https://docs.google.com/spreadsheets/d/1Je-YUdnhjQJO_13r8iTeRxpU2pBKuV6RVRHoYCgiMfg/edit#gid=322165570).
 
Per lo scrapping della pagina vedi script nel file *wiki_scrap.R*. <!--schiarire-->

```{r warning=FALSE, message=FALSE}
library(readr)
library(tidyr)
library(ggplot2)
library(dplyr)
library(modelr)
library(stringr)
#library(rcompanion)
#library(nnet)
library(gridExtra)
```

# IMPORT DEI DATI

Il dataset è composto da 43 features e 1145 record.

```{r warning=FALSE, message=FALSE}
# lettura dati
queensland <- read_delim("data/dataset.csv", delim = ';', na = c("Unknown", "Missing", "NA"))
wiki <- read_csv("data/wiki.csv", na = "unknown")
data_breaches_2018_update <- read_csv("data/Data Breaches - 2018 update.csv",comment = "#")
```

Si sfrutta la funzione 'read_delim()' per il fatto che il CSV una il punto e virgola come delimitatore.

<!--TODO: descrivere i dataset-->
## FEATURES

<!--TODO: riduurre la lista solo a features effettivamete utilizzate-->
* **Year**: anno in cui l'attacco è avvenuto ;
* **Organisation**: organizzazione attaccata ;
* **Critical industry**: ;
* **Organisation size**: dimensione dell'organizzazione ;
* **Level of digital intensity** ;
* **Sector**: settore di competenza dell'azienda ;
* **Country**:  ;
* **Cyber security role**: ;
* **Cyber security frameworks** ;
* **Education and awareness policy** ;
* **Policy** ;
* **Prevention, Detection and Recovery** ;
* **Improper network segmentation** ;
* **Inappropriate remote access** ;
* **Absence of encryption**: indicca l'assenza di crittografia;
* **Detector** ;
* **Restructuring after attack** ;
* **Bribe/ransom paid** ;
* **Free identity or credit theft monitoring** ;
* **Additional disclosure of information** ;
* **Number of users affected**: utenti che sono stati colpiti dall'attacco;
* **Overall nature of attack** ;
* **Attack type**: descrive il tipo di attacco;
* **Attacker**: descrive l'attaccante;
* **Attack vector**: mezzo usato per effettuare l'attacco;
* **Impact on data** ;
* **Aspect of Confidentiality-Integrity-Availability triad affected** ;
* **Individual(s) name(s) leaked/exposed** ;
* **Address(es) leaked/exposed** ;
* **Other personally identifiable information (PII) leaked/exposed** ;
* **Track 1 - Credit card details leaked/exposed** ;
* **Track 2 - Credit card details leaked/exposed** ;
* **Social security number/tax number leaked/exposed** ;
* **Subsequent fraudulent use of data** ;
* **Investigation** ;
* **Undertook investigation** ;
* **Litigation by public** ;
* **Penalties/settlement paid or actions imposed** ;
* **Imposed penalties or actions on organisation** ;
* **Fines issued by government or relevant body** ;
* **Settlement paid** ;
* **Effect on share price** ;
* **Summary**: descrizione dell'attacco ;

#NORMALIZZAZIONE

```{r message=FALSE, warning=FALSE}
queensland <- queensland %>% select(c(-...44, -`Effect on share price`, -`Overall nature of attack`))
wiki <- wiki %>% select(-Sources)
data_breaches_2018_update <- data_breaches_2018_update %>% 
  select(c(Entity : `1st source link`, `source name`, -YEAR, -`NO OF RECORDS STOLEN`)) %>%
  rename(YEAR = `YEAR(2)`)

queensland <- queensland %>% mutate(`Number of users affected` = as.numeric(`Number of users affected`))
wiki <- wiki %>% mutate(Year = as.numeric(Year), Records = as.numeric(str_remove_all(wiki$Records, ",")))
```

<!--Sscrivere commento inerente alle variabili escluse-->

# DOMANDE
1. Come sono cresciuti gli attacchi con il passare degli anni?
2. Qual'è il settore che è stato maggiormente colpito?
3. Com'è cresciuto il volume di dati esfiltrati con il passare del tempo?
4. Che relazione esite tra sistemi di sicurezza implementati e le conseguenze di tale attacco?


## Come sono cresciuti col passare gli anni gil attacchi?
Dai 3 dataset vado ad estrarre le features che riguardano il nome dell'azienda che è stata vittima dell'attacco o data-breach, l'anno, il paese, il settore di competenza e le tecniche di attacco.
Lo scopo di estrarre tali features è andare a studiare la crescita o la diminuzione del numero di attacchi.
```{r warning=FALSE, message=FALSE}
split_date <- function(){
  res <- list()
  
  for(year in wiki_attacks$Year)
    res <- c(res, as.numeric(str_split(year, "-")[[1]][1]))
  return(unlist(res))
}
```


```{r warning=FALSE, message=FALSE}
wiki_attacks <- wiki %>% select(c(Year, Entity, `Organization type`, Method, Records)) %>%
  rename(Sector = `Organization type`, `Attack type` = Method)
wiki_attacks <- wiki_attacks %>% mutate(Year = split_date())

data_breaches_2018_update_attacks <- data_breaches_2018_update %>% 
  select(c(YEAR, Entity, ORGANISATION, `METHOD OF LEAK`, `records lost`)) %>%
  rename(Year = YEAR, Sector = ORGANISATION, `Attack type` = `METHOD OF LEAK`, Records = `records lost`)

queensland_attacks <- queensland %>% select(c(Year, Organisation, Sector, `Attack type`, `Number of users affected`)) %>%
  rename(Entity = Organisation, Records = `Number of users affected`)

attacks <- union_all(union_all(wiki_attacks, data_breaches_2018_update_attacks), queensland_attacks) %>%
  filter(!is.na(Year))
```

```{r warning=FALSE, message=FALSE}
#grafico andamento del numero di attacchi in funzione del tempo
attack_year <- attacks %>% group_by(Year) %>%
  summarise(attack = n())

ggplot(attack_year, aes(x = Year, y = attack, )) + 
  geom_line()
  
```
<!--da fare analisi-->

## Qual'è il settore che è stato maggiormente colpito?

```{r warning=FALSE, message=FALSE}
#grafico andamento del numero di attacchi in funzione al settore
attack_sector <- attacks %>%
  group_by(Sector) %>%
  summarise(attacks = n()) %>%
  filter(attacks > 30) %>%
  arrange(-attacks)

attack_sector
```

```{r warning=FALSE, message=FALSE}
attack_sector %>% ggplot() +
  geom_bar(aes(x = "", y = attacks, fill = Sector), stat = "identity", color = "white") +
  #annotate("text", x = "", y = attacks, label = Sector) +
  coord_polar("y", start = 0) +
  theme_void()
```
<!--da fare analisi, trovare spiegazione perchè proprio quel settore-->
```{r warning=FALSE, message=FALSE}
health <- queensland %>% filter(Sector == "Human health activities") %>%
    select(c(`Critical Industry`, 
             `Organisation size`,
             `Level of digital intensity`,
             `Cyber security role` : `Additional disclosure of information`,
             -Detector))
```

```{r warning=FALSE, message=FALSE}
#TODO: vedere se è sostituibile con lapply
##TODO: vedere colori
plots <- list()

for (feature in names(health)) {
  plots[[feature]] <- health %>% filter(!is.na(!!as.symbol(feature))) %>%
    group_by(!!as.symbol(feature)) %>% 
    ggplot(aes(x = !!as.symbol(feature), fill = feature)) +
    scale_fill_manual(values = c("Yes" = "green",
                                 "No" = "red",
                                 "Small" = "red",
                                 "Low-Medium" = "orange",
                                 "Medium" = "cyan",
                                 "High" = "green")) +
    geom_bar() +
    theme_classic() +
    theme(text = element_text(size = 10), legend.position = "none")
}

do.call("grid.arrange", c(plots, ncol = 4))
```
<!--da scrivere analisi-->

## Com'è cresciuto il volume di dati esfiltrati con il passare del tempo?

```{r warning=FALSE, message=FALSE}
attacks %>% group_by(Year) %>%
  summarise(median = median(Records, na.rm = TRUE))
```

```{r warning=FALSE, message=FALSE}
attacks  %>% filter(Records < 10000000) %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(x = Year, y = Records, )) +
  geom_boxplot(na.rm = TRUE) +
  theme_classic()
```
<!--realizzare ananlisi -->

```{r warning=FALSE, message=FALSE}
#Organization size - Number of users affected
queensland  %>% filter(`Number of users affected` < 1000000 & !is.na(`Organisation size`)) %>%
  filter(!is.na(`Number of users affected`)) %>%
  ggplot(aes(x = `Organisation size`, y = `Number of users affected`), na.rm = TRUE) +
  geom_boxplot(na.rm = TRUE) +
  theme_classic()
```
<!--inserire analisi-->

```{r warning=FALSE, message=FALSE}
# Level of digital intensity - Number of users affected
queensland  %>% filter(`Number of users affected` < 1000000) %>%
  ggplot(aes(x = `Level of digital intensity`, y = `Number of users affected`), na.rm = TRUE) +
  geom_boxplot(na.rm = TRUE) +
  theme_classic()
```
<!--inserire analisi-->

```{r warning=FALSE, message=FALSE}
# DATA SENSITIVITy - Number of users affected
data_breaches_2018_update  %>% mutate(`DATA SENSITIVITY` = as.character(`DATA SENSITIVITY`)) %>%
  filter(`records lost` < 100000000 & `DATA SENSITIVITY` != "3") %>%
  ggplot(aes(x = `DATA SENSITIVITY`, y = `records lost`), na.rm = TRUE) +
  geom_boxplot(na.rm = TRUE) +
  theme_classic()
```
<!--inserire analisi-->
<!--forse va tolto-->

Dall'analisi fatta sopra si vede che l'unica ad influenzare la quantità di dati esfiltrati da un data breach è la dimensione dell'azienda.

Per verificare se c'è una relazione di qualche tipo tra anno e quantità di record estratti si deve andare a slegare la quantità di record estratti dalla dimensione dell'azienda.

```{r warning=FALSE, message=FALSE}
#TODO: da sistemare
queensland_factorized <- queensland %>%
   select(Year, `Organisation size`, `Number of users affected`) %>%
   mutate_if(is.character, as.factor) %>% 
   mutate_if(is.factor, unclass) %>%
   mutate_if(is.integer, as.character) %>%
   mutate_if(is.character, as.numeric)

model <- lm(`Organisation size` ~ `Number of users affected`, data = queensland_factorized)
#model <- multinom(`Organisation size` ~ `Number of users affected`, data = queensland_factorized)
queensland_factorized <- add_predictions(queensland_factorized, model)
queensland_factorized <- add_residuals(queensland_factorized, model)
```

```{r warning=FALSE, message=FALSE}
queensland_factorized  %>% mutate(Year = as.character(Year)) %>% 
  ggplot(aes(x = Year, y = resid), na.rm = TRUE) +
  geom_ref_line(h = 0)
  geom_boxplot(na.rm = TRUE)
```


## Che relazione esite tra sistemi di sicurezza implementati e le conseguenze di tale attacco?

```{r warning=FALSE, message=FALSE}
sec_conseguences <- queensland %>% select(c(`Cyber security role` : `Absence of encryption`, 
                                            `Restructuring after attack` : `Free identity or credit theft monitoring`,
                                            `Individual(s) name(s) leaked/exposed` : `Subsequent fraudulent use of data`,
                                            `Undertook investigation` : `Settlement paid`,
                                            -`Prevention, Detection and Recovery`))

sec_system <- sec_conseguences %>% select(c(`Cyber security role` : `Absence of encryption`, 
                                            `Restructuring after attack` : `Free identity or credit theft monitoring`))
consequences <- sec_conseguences %>% select(c(`Individual(s) name(s) leaked/exposed` : `Subsequent fraudulent use of data`,
                                              `Undertook investigation` : `Settlement paid`))
```

```{r warning=FALSE, message=FALSE}
sec_conseguences_occurs <- matrix(0, nrow = 10, ncol = 13)
rownames(sec_conseguences_occurs) <- c(names(sec_conseguences)[1 : 10])
colnames(sec_conseguences_occurs) <- c(names(sec_conseguences)[11 : 23])
```

```{r warning=FALSE, message=FALSE}
# vedere se si riesce usando funzione apply
for (row in names(sec_conseguences)[1 : 10]){
  for (col in names(sec_conseguences)[11 : 23]){
    sec_conseguences_occurs[row, col] <- dim(sec_conseguences %>% select(c(row, col)) %>% 
          filter(!!as.symbol(row) == 'Yes' & !!as.symbol(col) =='Yes'))[1]
  }
}
```
<!--inserire spiegazione !! prima della comversione di tipo-->

```{r warning=FALSE, message=FALSE}
cramerV(sec_conseguences_occurs)
```

```{r warning=FALSE, message=FALSE}
cramerV_table <-  matrix(0, nrow = 10, ncol = 13)
rownames(cramerV_table) <- c(names(sec_conseguences)[1 : 10])
colnames(cramerV_table) <- c(names(sec_conseguences)[11 : 23])

for (row in names(sec_conseguences)[1 : 10])
  for (col in names(sec_conseguences)[11 : 23])
    cramerV_table[row, col] <- cramerV(table(unlist(sec_conseguences[row]), unlist(sec_conseguences[col])))

cramerV_table
```
<!--inserire analisi-->
